"here",
"hms",
#"janitor",
#"lubridate",
"magrittr",
#"maptools",
#"optimbase",
#"plyr",
#"raster",
#"readxl",
#"rgdal",
#"rgeos",
#"rjags",
#"rlecuyer",
#"sf",
#"showtext",
#"snowfall",
#"sp",
#"stringr",
"tidyverse"
)
for (package in package.list) {
if (!require(package, character.only=T, quietly=T)) {
install.packages(package)
library(package, character.only=T)
}
}
##Camera Traps detection histories
#loading the environmental variables and using only the user IDs that are within the cov table
stacked_raster_values_and_garden_CT_all_seasons_no_nas <- readRDS(here::here("data-raw", "r-raw", "stacked_raster_values_and_garden_CT_all_seasons_allcovs_Renamed2022_01_19.RDS"))
#already formatted and filtered camera trap data with a delta of 30 mins
CT_act_date_formated_delta30 <- readRDS(here::here("data-raw", "r-raw","CT_act_allspecies_NoDelta_filtered2022_01_19.RDS"))
CT_act_day <- CT_act_date_formated_delta30
#extract the hours between 5am and 6pm,
medium_day <- CT_act_day %>% dplyr::filter(Time >= hms::as_hms("05:00:00"),
Time <= hms::as_hms("19:00:00"))
table(medium_day$Species)
# #saving the output
# saveRDS(object = medium_day,
#         file = here::here("output", "data-proc", "temporal_proc",
#                           paste0("medium_day_",gsub(pattern = "-", replacement = "", x = Sys.Date()),".RDS")))
#a bit of formating
data_interest <- medium_day
data_interest %<>%
mutate(Species = as.factor(Species),
Station = as.integer(Station))
data_interest <- as.data.frame(data_interest)
# Extracting the IDs of the CT that detected species of interest
id_CT <- unique(data_interest$Station)
#list of species of interest
species_interest <- c("Eichhörnchen", "cat", "Waschbär","Rotfuchs", "Marder_(Baum-und_Steinmarder)")
View(data_interest)
calculate_delta <- function(species)
{
#empty list
delta_species <- list(0)
###loop starts here
for(j in id_CT)
{
k = which(id_CT == j)
#take the CT by its id
B <- data_interest %>% filter(Station == j)
#order it by date and time
B_ordered <- B %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(B_ordered))
for(i in 1: (nrow(B_ordered)))
{
if (paste(B_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
diff <- difftime(B_ordered[i,"DateTimeOriginal"], B_ordered[i+1,"DateTimeOriginal"])
if (diff < - 12)
{
delta[i] <- 0 #if the time difference is more than 12 hours then we set it back to zero because it means too                             much time has spent
}
if (diff >= -12)
{
delta[i] <- diff
}
}
}
delta_species[[k]] <- delta
names(delta_species)[k] <- as.character(j)
}
return(delta_species)
}
#### TEST ####
##############
##############
calculate_delta <- function(species)
{
#empty list
delta_species <- list(0)
###loop starts here
for(numberCT in id_CT) # j umbenennen zu numberCT, da j = Platzhalter für jede CT ID
{
#print(paste0("j ", j))
numberEle <- which(id_CT == numberCT) # k umbennen in numberEle da Platzhalter für jedes Element der Reihe nach
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
return(delta_species)
}
df <- tibble::tibble(
a = rnorm(10),
b = rnorm(10),
c = rnorm(10),
d = rnorm(10)
)
(df$a - min(df$a, na.rm = TRUE)) /
(max(df$a, na.rm = TRUE) - min(df$a, na.rm = TRUE))
x <- df$a
x
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
#>  [1] 0.2892677 0.7509271 0.0000000 0.6781686 0.8530656 1.0000000 0.1716402
#>  [8] 0.6107464 0.6116181 0.6008793
#>
rng <- range(x, na.rm = TRUE)
rng
?range
?Sys.time
?system.time
Sys.time()
#### TEST ####
##############
##############
# 1st function: for loop 1 take out pics of species of interest per station and order them by date and time
# 2nd function:  calculate the time differences
calculate_delta <- function(species)
{
print(paste0("Start Time", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
return(delta_species)
print(paste0("End Time", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken", time.taken))
}
time_diff <- function(Pics_CT_ordered){
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
}
calculate_delta_2 <- function(species) {
print(paste0("Start Time", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
time_diff(Pics_CT_ordered)
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
return(delta_species)
print(paste0("End Time", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken", time.taken))
}
# Als loop???
##selecting the species squirrel and cat
species <- c(species_interest[1],species_interest[2])
delta_squirrel_cat <- calculate_delta(species) #loop in a loop in a loop I know it's not very efficient.... sorry
calculate_delta_2 <- function(species) {
print(paste0("Start Time", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
time_diff(Pics_CT_ordered)
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
print(paste0("End Time", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken", time.taken))
return(delta_species)
}
delta_squirrel_cat <- calculate_delta_2(species)
time_diff <- function(Pics_CT_ordered){
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
}
calculate_delta_2 <- function(species) {
print(paste0("Start Time", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
time_diff(Pics_CT_ordered)
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
print(paste0("End Time", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken", time.taken))
return(delta_species)
}
delta_squirrel_cat <- calculate_delta_2(species)
#### TEST ####
##############
##############
# 1st function: for loop 1 take out pics of species of interest per station and order them by date and time
# 2nd function:  calculate the time differences
calculate_delta <- function(species)
{
print(paste0("Start Time", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
print(paste0("End Time", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken", time.taken))
return(delta_species)
}
delta_squirrel_cat <- calculate_delta(species) #loop in a loop in a loop I know it's not very efficient.... sorry
delta_squirrel_cat <- calculate_delta(species) #loop in a loop in a loop I know it's not very efficient.... sorry
calculate_delta <- function(species)
{
print(paste0("Start Time ", Sys.time()))
start.time <- Sys.time()
#empty list
delta_species <- list(0)
###loop starts here
# numberCT: each element of station ID
for(numberCT in id_CT)
{
#print(paste0("j ", j))
#numberEle
numberEle <- which(id_CT == numberCT)
#print(paste0("k ", k))
#take the CT by its id, und filter alle Fotos der species of interest pro station/CT
Pics_CT <- data_interest %>% filter(Station == numberCT)
#order it by date and time (maybe not necessary, but just in case there is something in the wrong order)
Pics_CT_ordered <- Pics_CT %>% arrange(DateTimeOriginal)
#delta is going to contain the calculated difference of time between species A and B for each row of the detections of the CT
#but only if the two species from row i and i+1 are in the specific order
#if the combination of the species names between the row i and i + 1 is equal to the names of the species of interest     stuck togetehr then we calcutalte difftime between the two lines,  otherwise, no
delta <- rep(NA, nrow(Pics_CT_ordered)) # create a empty vector with NAs for calculations later
for(i in 1: (nrow(Pics_CT_ordered))) # for each row per B-ordered data set, starting from row 1
{
# wenn die Species namenskombi vom foto und dem nächsten Foto gleich ist wie die der gewünschen specieskombi, dann....
if (paste(Pics_CT_ordered[c(i:(i+1)),"Species"], collapse ="") == paste(species, collapse=""))
{
# Berechne den zeitunterschied zwischen dem Foto und dem nächsten
diff <- difftime(Pics_CT_ordered[i,"DateTimeOriginal"], Pics_CT_ordered[i+1,"DateTimeOriginal"])
#if the time difference is more than 12 hours ....
if (diff < - 12)
{
# then we set it back to zero because it means too much time has spent
delta[i] <- 0
}
# if not
if (diff >= -12)
{
# we save the time difference in delta
delta[i] <- diff
}
}
}
# save delta in the delta species list at the place of k
delta_species[[numberEle]] <- delta
# save the name of the CT ID
names(delta_species)[numberEle] <- as.character(numberCT)
}
print(paste0("End Time ", Sys.time()))
end.time <- Sys.time()
time.taken <- end.time - start.time
print(paste0("Time taken ", time.taken))
return(delta_species)
}
delta_squirrel_cat <- calculate_delta(species) #loop in a loop in a loop I know it's not very efficient.... sorry
?ldply
species_interest[1]
species_interest[1+1]
species_interest
species_interest[1+1+1+1]
seq_along(species_interest)
species_interest[[1]]
species_interest[1]
##selecting the species squirrel and cat
species <- c(species_interest[1],species_interest[2])
delta_squirrel_cat <- calculate_delta(species) #loop in a loop in a loop I know it's not very efficient.... sorry
#putting this in a dataframe
df_time_diff_squirrel_cat1 = plyr::ldply(delta_squirrel_cat1, rbind)
#putting this in a dataframe
df_time_diff_squirrel_cat1 = plyr::ldply(delta_squirrel_cat, rbind)
average_diff_squirrel_cat_id1 <- df_time_diff_squirrel_cat1 %>%
mutate(User_uid = as.numeric(.id)) %>%
mutate(mean = rowMeans(df_time_diff_squirrel_cat1[,-1], na.rm = T)) %>% #rowmeans
dplyr::select(User_uid, mean) #keeping only the mean and the id column
View(df_time_diff_squirrel_cat1)
View(average_diff_squirrel_cat_id1)
assign(paste("A",i, sep=""), (d + rnorm(3)))
assign(paste("A","i", sep=""), ("d + rnorm(3)"))
ai
Ai
?assign
i <- 1
paste("average_diff_",species_interest[[i]], species_interest[[i+1]], sep="")
paste("average_diff",species_interest[[i]], species_interest[[i+1]], sep="_")
