---
title: "Your Project: Data Preparation" ## name of your project and analysis step
description: |
    The aim of this study is...
author:
    ## author information; single arguemnts can be deleted if not needed
    - name: "John Smith"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
      orcid_id: 0000-0000-0000-0000
    - name: "Jane Doe"
      url: https://janedoe.com
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
    ## add more authors with the same intendation and styling if needed 
    ## a new author always starts with a hyphen!
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate      ## styling of code
        code_folding: false  ## if `true` you can expand and shrink code chunks
        toc: true            ## if `true` adds a table of content
        toc_depth: 2         ## level to be displayed in the table of content
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", fig.width = 9, fig.height = 6, dpi = 600, retina = 1)
Sys.setlocale("LC_TIME", "C")
```

* **Research question:**
* **Study area:**
* **Data:** 


# Setup

```{r packages}
# install the package librarian, it loads and installs (if necessary) the specified packages from CRAN, GitHub or Bioconductor
# it will not update already installed packages

#devtools::install_github("DesiQuintans/librarian")
librarian::shelf(update_all = FALSE,
                 #camtrapR,
                 bayestestR, 
                 DHARMa,
                 easystats / easystats, 
                 effects,
                 extrafont, 
                 ggeffects,
                 #ggplot2, 
                 ggpubr, 
                 here, 
                 insight,
                 performance, 
                 plyr,
                 rstanarm, 
                 stringr, 
                 tidyverse, 
                 )
```


# Data
```{r Data}
# CT squirrels per station
CT_squirrels_station <- readRDS(here::here("output",
                                           "data-proc",
                                           "all_seasons",
                                           "CT_squirrels_per_station_20230223.RDS"))
```

Palettes
```{r palette}
# darkdarkblue beige greyblue brown red
pal_5 <- c("#303B4A", "#E4CAA5", "#4D6476", "#837461", "#C83649") # 
pal_3 <- c("#E4CAA5", "#4D6476", "#837461")
pal_2 <- c("#E4CAA5", "#4D6476")
```

Fonts
```{r load fonts, message=FALSE, include=FALSE}
#font_import()
loadfonts(device = "win")
fonts()
```

# Bayesian approach
## Null + seasonal models
```{r include=FALSE}
# Null model
null_bmod <- stan_glm.nb(formula = sum_pic ~ 1, 
                         data = CT_squirrels_station)

# Null model with Season and lockdown
season_lock_bmod <- stan_glm.nb(formula = sum_pic ~ 1 + Season + lockdown, 
                                data = CT_squirrels_station)
```


## Full models
```{r include=FALSE}
# Full model with explanatory variables of urban and garden level
env_pred_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + scale(noise_2017) + 
                               scale(pop_2019) + scale(distance_to_border) +
                               scale(garden_size) + dogs_binary + 
                               cats_cam_binary + marten_cam_binary +
                               Season + lockdown,
                             data = CT_squirrels_station)

imp_pred_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + 
                               scale(garden_size) + dogs_binary + 
                               cats_cam_binary + marten_cam_binary +
                               Season + lockdown,
                             data = CT_squirrels_station)

env_dog_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + scale(noise_2017) + 
                              scale(pop_2019) + scale(distance_to_border) +
                              scale(garden_size) + dogs_binary + 
                              Season + lockdown,
                            data = CT_squirrels_station)

imp_dog_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + 
                              scale(garden_size) + dogs_binary + 
                              Season + lockdown,
                            data = CT_squirrels_station)
```

## Urban models
```{r}
env_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + scale(noise_2017) + 
                          scale(pop_2019) + scale(distance_to_border) +
                          Season + lockdown,
                        data = CT_squirrels_station)

imp_bmod <- stan_glm.nb(formula = sum_pic ~ scale(imperviousness_2018) + 
                          Season + lockdown,
                        data = CT_squirrels_station)
```

## Garden models
```{r include=FALSE}
# Urban model with explanatory variables of garden level

pred_bmod <- stan_glm.nb(formula = sum_pic ~ scale(garden_size) + dogs_binary + 
                           cats_cam_binary + marten_cam_binary +
                           Season + lockdown,
                         data = CT_squirrels_station)

dog_bmod  <- stan_glm.nb(formula = sum_pic ~ scale(garden_size) + dogs_binary + 
                           Season + lockdown,
                         data = CT_squirrels_station)
```

## Predators
```{r include=FALSE}
catmarten_bmod <- stan_glm.nb(formula = sum_pic ~ cats_cam_binary + marten_cam_binary +
                           Season + lockdown,
                         data = CT_squirrels_station)
```

## Overall comparison
### Parameters
```{r}
# compare_parameters(null_mod_bayes, season_lock_mod_bayes, full_mod_bayes,
#                    urban_mod_bayes, garden_mod_bayes, select = "minimal")
```

### Posteriors
```{r}
# Null
describe_posterior(null_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# Season + Lockdown
describe_posterior(season_lock_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# Full
describe_posterior(env_pred_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
describe_posterior(imp_pred_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
describe_posterior(env_dog_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
describe_posterior(imp_dog_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# Urban
describe_posterior(env_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
describe_posterior(imp_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# Garden
describe_posterior(pred_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
describe_posterior(dog_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# Predators
describe_posterior(catmarten_bmod, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
```

### ROPE
```{r ROPE}
# Plots of the significance: Region of Practical Equivalence (ROPE)
# Null model
plot(rope(null_bmod))+ 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) + 
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))

# Seasonal model
plot(rope(season_lock_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(labels=c("Lockdown yes", "Season spring"), expand = c(1.1,0)) # expand = expansion(mult = 0.9),
```


```{r ROPE}
# All predators all environmental covariates
plot(rope(env_pred_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.15, 0.001), labels = c("reciprocal dispersion", "Lockdown = yes", "Season = spring", 
                                                       "Marten on cams = yes", "Cats on cams = 1", "Dogs as pets = yes", 
                                                       "Garden size", "Distance to city border", "Population density", "Noise", "Imperviousness")) + 
  scale_fill_manual(values = pal_2) # c("#4D6476", "#E4CAA5")
```


```{r ROPE}
# All predators and imperviousness
plot(rope(imp_pred_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))
```


```{r ROPE}
# Dogs all environmental covariates
plot(rope(env_dog_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))
```


```{r ROPE}
# Dogs and imperviousness
plot(rope(imp_dog_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))
```


```{r ROPE}
# Urban model: all environmental covariates
plot(rope(env_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) + 
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))
```


```{r ROPE}
# Urban model imperviousness
plot(rope(imp_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) + 
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))

# Garden model: all predators
plot(rope(pred_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))

# Garden model: dogs
plot(rope(dog_bmod)) + 
  scale_x_continuous(
    limits = c(-5, 5),
    breaks = seq(-5, 5, by = 1),
    expand = c(.02, .001)) +
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_y_discrete(expand = c(0.25, 0.001))
```


### Performance
Plot of the model performance for different parameters
```{r}
plot(compare_performance(null_bmod, season_lock_bmod, env_pred_bmod, imp_pred_bmod, 
                    env_dog_bmod, imp_dog_bmod, env_bmod, imp_bmod, 
                    pred_bmod, dog_bmod))
```
Build a table for model comparison
```{r}
# compare all models
full_compare_bayes <- as_tibble(
  compare_performance(
    null_bmod, season_lock_bmod, env_pred_bmod, imp_pred_bmod, 
    env_dog_bmod, imp_dog_bmod, env_bmod, imp_bmod, 
    pred_bmod, dog_bmod, catmarten_bmod))
```

Calculate McFaddens Pseudo R2
```{r}
mcf_r2_all_models <- c(r2_mcfadden(null_bmod)$R2_adjusted, 
                       r2_mcfadden(season_lock_bmod)$R2_adjusted, 
                       r2_mcfadden(env_pred_bmod)$R2_adjusted, 
                       r2_mcfadden(imp_pred_bmod)$R2_adjusted,
                       r2_mcfadden(env_dog_bmod)$R2_adjusted, 
                       r2_mcfadden(imp_dog_bmod)$R2_adjusted, 
                       r2_mcfadden(env_bmod)$R2_adjusted,
                       r2_mcfadden(imp_bmod)$R2_adjusted, 
                       r2_mcfadden(pred_bmod)$R2_adjusted,
                       r2_mcfadden(dog_bmod)$R2_adjusted, 
                       r2_mcfadden(catmarten_bmod)$R2_adjusted)
```
#### Full table
```{r}
full_compare_bayes <- full_compare_bayes %>%
  mutate(pseudo_r2 =  mcf_r2_all_models) %>%
  arrange(WAIC) %>%
  mutate(delta_WAIC = WAIC - WAIC[1]) %>%
 # arrange(desc(WAIC)) %>%
  relocate(delta_WAIC, .after = WAIC_wt)

full_compare_bayes
```

### Prediction plots
```{r}
plot(ggpredict(env_pred_bmod))
```

All environmental variables and all predators
```{r}
ggplot(data = env_var, mapping = aes(x = project_phase, fill = dogs_binary)) + #y = n, 
  geom_bar(position = "dodge") + 
  scale_y_continuous(
    limits = c(0, 600),
    breaks = seq(0, 600, by = 100),
    expand = c(.001, .001)) + 
  labs(title = "Dogs vs Project phase", x = "Project phase") + 
  theme_pubr() + 
  theme(legend.position = "none", 
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 1.5),
        axis.ticks.length = unit(0.2, "cm"),
        plot.margin = margin(6, 10, 4, 4)) +
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_colour_manual(values = pal_2, guide = "none") +
  scale_fill_manual(values = pal_2, guide = "none") + 
  scale_x_discrete(expand = c(0.2, 0.001))
```

```{r}
plot(ggpredict(env_pred_bmod, terms = "imperviousness_2018"), line.size = 1) + 
  scale_y_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 5),
    expand = c(.001, .001)) + 
  scale_x_continuous(expand = c(.001, .001)) + 
  labs(y = "Number of pictures per station", x = "Imperviousness", title = "Predicted number of pictures") + 
  theme_pubr() + 
  theme(legend.position = "none", 
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 2), 
        axis.ticks = element_line(colour = "black", linewidth = 1.5),
        axis.ticks.length = unit(0.2, "cm"),
        plot.margin = margin(6, 10, 4, 4)) +
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11)
```

All environmental variables without predators
```{r}
plot(ggpredict(env_bmod))
```

All environmental variables and dogs
```{r}
plot(ggpredict(env_dog_bmod))
```


***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>
