
---
title: "Your Project: Data Preparation" ## name of your project and analysis step
description: |
    The aim of this study is...
author:
    ## author information; single arguemnts can be deleted if not needed
    - name: "John Smith"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
      orcid_id: 0000-0000-0000-0000
    - name: "Jane Doe"
      url: https://janedoe.com
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
    ## add more authors with the same intendation and styling if needed 
    ## a new author always starts with a hyphen!
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate      ## styling of code
        code_folding: false  ## if `true` you can expand and shrink code chunks
        toc: true            ## if `true` adds a table of content
        toc_depth: 2         ## level to be displayed in the table of content
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", fig.width = 9, fig.height = 6, dpi = 600, retina = 1)
Sys.setlocale("LC_TIME", "C")
```

* **Research question:**
* **Study area:**
* **Data:** 


# Setup

```{r packages}
# install the package librarian, it loads and installs (if necessary) the specified packages from CRAN, GitHub or Bioconductor
# it will not update already installed packages

#devtools::install_github("DesiQuintans/librarian")
librarian::shelf(update_all = FALSE,
                 #camtrapR,
                 bayestestR, 
                 DHARMa,
                 easystats / easystats, 
                 effects,
                 extrafont, 
                 ggeffects,
                 #ggplot2, 
                 ggpubr, 
                 here, 
                 insight,
                 lme4, 
                 performance, 
                 plyr,
                 rstanarm, 
                 stringr, 
                 tidyverse, 
                 )
```


# Data

```{r data}
CT_squirrel_predators_hour <- readRDS(here::here("output",
                                            "data-proc",
                                            "all_seasons",
                                            "CT_squirrel_left_join_20230228.RDS"))

# CT_squirrel_full_join <- readRDS(here::here("output",
#                                             "data-proc",
#                                             "all_seasons",
#                                             "CT_squirrel_full_join_20230223.RDS"))
```

```{r}
CT_squirrel_predators_hour %>%
  #group_by(Species, hour_day) %>%
  #dplyr::summarize(n_hour = sum(squirrel_sum_hour), sd_hour = sd(squirrel_sum_hour)) %>%
  #ungroup() %>%
  #complete(hour_day = c(0:23), fill = list(n_hour = 0, sd_hour = 0))  %>%
  ggplot(mapping = aes(x = squirrel_sum_hour)) + 
  geom_histogram(stat = "bin", position = "identity", fill = "#303B4A") +
  scale_y_continuous(
    limits = c(0, 1700),
    breaks = seq(0, 1700, by = 100),
    expand = c(.008, .001)) +
  scale_x_continuous(limits = c(-1, 20),
                     expand = c(.001, .001)) +
  labs(x = "Number of squirrel pictures per station") + 
  theme_pubr() + 
  theme(legend.position = "none", 
        panel.border = element_rect(colour = "black", fill=NA, linewidth=2), 
        axis.ticks = element_line(colour = "black", linewidth = 1.5),
        axis.ticks.length = unit(0.2, "cm"),
        plot.margin = margin(6, 10, 4, 4)) +
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) 
```


# Model
set the seed
```{r}
set.seed(20200604)
```

```{r}
# phase_3 <- CT_squirrel_left_join %>%
#   filter(project_phase == 3)
```

```{r}
# mod2 <- glmer(squirrel_sum_hour ~ (poly(hour_day,4) + scale(imperviousness_2018) + dogs_binary + cats_binary) + 
#                      (1|Station), # cat_pics + marten_pics +  
#                    data = phase_3, 
#                    family = poisson(link = "log"))

```


```{r}
 # AT THE BEGINNING OF THE SCRIPT!!!!!!!!!!
# mod1 <- stan_glmer(squirrel_sum_hour ~ (poly(hour_day,2) + scale(imperviousness_2018) + dogs_binary + cats_binary)*lockdown + 
#                      (1|Station), # cat_pics + marten_pics +  
#                    data = CT_squirrel_left_join, 
#                    family = poisson(link = "log"))
# 
# mod1
# 
# mod2 <- glmer(squirrel_sum_hour ~ (poly(hour_day,3) + scale(imperviousness_2018) + dogs_binary + cats_binary + Season)*lockdown + 
#                      (1|Station), # cat_pics + marten_pics +  
#                    data = CT_squirrel_left_join, 
#                    family = poisson(link = "log"))
# mod1
# mod2
```

```{r}
#CT_squirrel_left_join$hour_fac <- as.factor(CT_squirrel_left_join$hour_day)
```

```{r}
# mod3 <- glmer(squirrel_sum_hour ~ (hour_fac + scale(imperviousness_2018) + dogs_binary + cats_binary)*lockdown + 
#                      (1|Station), # cat_pics + marten_pics +  
#                    data = CT_squirrel_left_join, 
#                    family = poisson)

```

```{r}
#plot(allEffects(mod1))
```


```{r}
#plot(allEffects(mod2))
```

```{r}
#plot(rope(mod1))
```

```{r}
# plot(ggpredict(mod1))
# plot(ggpredict(mod2, terms = c("hour_day", "lockdown", "cats_binary"), ci = T))
# plot(ggpredict(mod3, terms = c("hour_fac", "lockdown")))
# plot(ggpredict(mod2, terms = c("hour_day", "imperviousness_2018", "lockdown")))
# summary(mod2)
```


```{r}
# mod4 <- glmer(squirrel_sum_hour ~ (scale(poly(hour_day,4)) + scale(imperviousness_2018))*lockdown + Season + 
#                      (1|Station),   
#                    data = CT_squirrel_left_join, 
#                    family = poisson(link = "log"))

# mod4 <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + scale(imperviousness_2018)*poly(hour_day,4)
#               + (1|Station),   
#                    data = CT_squirrel_left_join, 
#                    family = poisson(link = "log"))

mod5 <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + scale(imperviousness_2018)*poly(hour_day,4) + 
                dogs_binary*poly(hour_day,4) 
                + (1|Station),   
              data = CT_squirrel_predators_hour, 
              family = poisson(link = "log"))
```

```{r}
summary(mod5)
# plot(ggpredict(mod4))
# plot(ggpredict(mod4, terms = c("hour_day", "lockdown")))


plot(ggpredict(mod5, terms = c("hour_day", "lockdown")))
plot(ggpredict(mod5, terms = c("hour_day", "imperviousness_2018")))
plot(ggpredict(mod5, terms = c("hour_day", "dogs_binary")))
plot(ggpredict(mod5, terms = c("hour_day", "dogs_binary", "lockdown")))
#plot(ggpredict(mod5, terms = c("hour_day", "cats_binary")))

```

```{r}
# takes around 5 minutes
mod6 <- stan_glmer(formula = squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + scale(imperviousness_2018)*poly(hour_day,4) + 
                     dogs_binary*poly(hour_day,4) 
                   + (1|Station),   
                   data = CT_squirrel_predators_hour, 
                   family = poisson(link = "log"))
#?stan_glmer
```

```{r}
describe_posterior(mod6, test = c("p_direction", "rope", "bayesfactor"), ci_method = "HDI")
# plot(ggpredict(mod4))
# plot(ggpredict(mod4, terms = c("hour_day", "lockdown")))


plot(ggpredict(mod6, terms = c("hour_day", "lockdown")))
plot(ggpredict(mod6, terms = c("hour_day", "imperviousness_2018")))
plot(ggpredict(mod6, terms = c("hour_day", "dogs_binary", "lockdown")))
#plot(ggpredict(mod5, terms = c("hour_day", "cats_binary")))

```

```{r fig.height=10, fig.width=10}
plot(rope(mod6))
```

# Predator analyses
Nur stationen filtern bei denen mindestens einmal in der Laufzeit ein Foto von Katzen bzw. Mardern war
Dann pro tag berechnen ob Katze/Marder da war oder nicht
Dann Number of pictures per hour of the day for days with cats or without cats
2 rows per hour per station (with cats vs without cats

  
# Days with/without predator  
## cats
```{r}
XX <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + presence_cat  
                + (1|Station),   
              data = CT_squirrel_predators_hour, 
              family = poisson(link = "log"))
XX <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + (poly(hour_day,4))*presence_cat  
                + (1|Station),   
              data = CT_squirrel_predators_hour, 
              family = poisson(link = "log"))

XX <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + presence_marten  
                + (1|Station),   
              data = CT_squirrel_predators_hour, 
              family = poisson(link = "log"))
XX <- glmer(squirrel_sum_hour ~ (poly(hour_day,4))*lockdown + Season + (poly(hour_day,4))*presence_marten  
                + (1|Station),   
              data = CT_squirrel_predators_hour, 
              family = poisson(link = "log"))
```

```{r}
station_cats <- CT_species_interest %>%
  filter(Species == "Cat") %>%
  dplyr::count(Species, project_phase, Station, Date)  %>% 
  #group_by(Species, Station, Date) %>%
  dplyr::mutate(pics_day_binary = case_when(n > 0 ~ 1)) %>%
  ungroup()
```


```{r}
station_cats_2 <- station_cats %>%
  filter(project_phase == "2") %>%
  complete(Station, Date = as.Date(c(as.Date("2019-04-01"):as.Date("2019-04-28")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Cat", project_phase = "2"))

station_cats_3 <- station_cats %>%
  filter(project_phase == "3") %>%
  complete(Station, Date = as.Date(c(as.Date("2019-09-30"):as.Date("2019-10-27")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Cat", project_phase = "3"))

station_cats_4 <- station_cats %>%
  filter(project_phase == "4") %>%
  complete(Station, Date = as.Date(c(as.Date("2020-03-30"):as.Date("2020-04-26")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Cat", project_phase = "4"))

station_cats_5 <- station_cats %>%
  filter(project_phase == "5") %>%
  complete(Station, Date = as.Date(c(as.Date("2020-09-28"):as.Date("2020-10-26")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Cat", project_phase = "5"))

station_cats <- rbind(station_cats_2, station_cats_3, station_cats_4, station_cats_5)
```

```{r}
table(station_cats$pics_day_binary)
length(unique(station_cats$Station))
```
what is when I do not have 
## martens
```{r}
station_martens <- CT_species_interest %>%
  filter(Species == "Marten") %>%
  dplyr::count(Species, project_phase, Station, Date)  %>% 
  #group_by(Species, Station, Date) %>%
  dplyr::mutate(pics_day_binary = case_when(n > 0 ~ 1)) %>%
  ungroup()
```


```{r}
station_martens_2 <- station_martens %>%
  filter(project_phase == "2") %>%
  complete(Station, Date = as.Date(c(as.Date("2019-04-01"):as.Date("2019-04-28")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Marten", project_phase = "2"))

station_martens_3 <- station_martens %>%
  filter(project_phase == "3") %>%
  complete(Station, Date = as.Date(c(as.Date("2019-09-30"):as.Date("2019-10-27")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Marten", project_phase = "3"))

station_martens_4 <- station_martens %>%
  filter(project_phase == "4") %>%
  complete(Station, Date = as.Date(c(as.Date("2020-03-30"):as.Date("2020-04-26")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Marten", project_phase = "4"))

station_martens_5 <- station_martens %>%
  filter(project_phase == "5") %>%
  complete(Station, Date = as.Date(c(as.Date("2020-09-28"):as.Date("2020-10-26")), 
                                   origin = "1970-01-01"), 
           fill = list(pics_day_binary = 0, n = 0, Species = "Marten", project_phase = "5"))

station_martens <- rbind(station_martens_2, station_martens_3, station_martens_4, station_martens_5)
```

```{r}
table(station_martens$pics_day_binary)
length(unique(station_martens$Station))
```


```{r}
# test <- CT_species_interest %>%
#   filter(Species == "Cat") %>%
#   dplyr::count(Species, project_phase, Station, Date)  %>% 
#   #group_by(Species, Station, Date) %>%
#   dplyr::mutate(pics_day_binary = case_when(n > 0 ~ 1)) %>%
#   case_when(project_phase == "2" ~ complete(Station, Date = as.Date(c(as.Date("2019-04-01"):as.Date("2019-04-28")), 
#                                                                     origin = "1970-01-01"), 
#                                             fill = list(pics_day_binary = 0, n = 0)), 
#             project_phase == "3" ~ complete(Station, Date = as.Date(c(as.Date("2019-09-30"):as.Date("2019-10-27")), 
#                                                                     origin = "1970-01-01"), 
#                                             fill = list(pics_day_binary = 0, n = 0)),
#             project_phase == "4" ~ complete(Station, Date = as.Date(c(as.Date("2020-03-30"):as.Date("2020-04-26")), 
#                                                                     origin = "1970-01-01"), 
#                                             fill = list(pics_day_binary = 0, n = 0)),
#             project_phase == "5" ~ complete(Station, Date = as.Date(c(as.Date("2020-09-28"):as.Date("2020-10-26")), 
#                                                                     origin = "1970-01-01"), 
#                                             fill = list(pics_day_binary = 0, n = 0)),) %>%
#               ungroup()
```

list_date_monthly[[2]] <- c(as.Date("2019-04-01"),
                           as.Date("2019-04-28")) #P2
list_date_monthly[[3]] <- c(as.Date("2019-09-30"), 
                           as.Date("2019-10-27")) #P3
list_date_monthly[[4]] <- c(as.Date("2020-03-30"),
                           as.Date("2020-04-26")) #P4
list_date_monthly[[5]] <- c(as.Date("2020-09-28"), 
                           as.Date("2020-10-26")) #P5



```{r}
station_cats2 <- CT_species_interest %>%
  filter(Species == "Cat") %>%
  #dplyr::count(Species, Station, Date)  %>% 
  group_by(Species, Station, Date) %>%
  dplyr::summarise(sum_pic_day = n()) %>%
  ungroup()
```


```{r}
CT_squirrels_station <- CT_per_station %>%
  filter(Species == "Cat") %>% 
  mutate(
    cats_cam_binary = case_when(
      Species == "Cat" & sum_pic > 0 ~ 1, 
      Species == "Cat" & sum_pic == 0 ~ 0)) %>%
  select(Station, cats_cam_binary) %>%
  right_join(y = CT_squirrels_station, by = "Station")
```


day_marten and day_cat as factor also binary 0 or 1
n pictures ~ hour*day_marten + hour*imperviousness + hour*lockdown + dog + (1|Station), poisson
n pictures ~ hour*day_cat  + hour*imperviousness  + hour*lockdown + dog + (1|Station), poisson,

Season??? Depends on how many observations we have


# Dhat
calculate dhat marten and cat per camera use a for-loop

dhat_marten ~ imp + lockdown + season + dogs, glm (weil  nur eine Beobachtung pro Kamera), gaussian distribution
dhat_cat ~ ...

OR
one table: dhat | predator species | station ... + column if both species are at this station or not
= one model for the dhat, cats and martens combined
for this: look how many stations have martens and cats


***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>
