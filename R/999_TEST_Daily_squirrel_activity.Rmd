---
title: "Your Project: Data Preparation" ## name of your project and analysis step
description: |
    The aim of this study is...
author:
    ## author information; single arguemnts can be deleted if not needed
    - name: "John Smith"
      url: https://izw-berlin.de/en/john-smith-en.html  
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
      orcid_id: 0000-0000-0000-0000
    - name: "Jane Doe"
      url: https://janedoe.com
      affiliation: Leibniz Institute for Zoo and Wildlife Research
      affiliation_url: https://izw-berlin.de/en/
    ## add more authors with the same intendation and styling if needed 
    ## a new author always starts with a hyphen!
date: "`r Sys.Date()`"
output: 
    distill::distill_article:
        highlight: kate      ## styling of code
        code_folding: false  ## if `true` you can expand and shrink code chunks
        toc: true            ## if `true` adds a table of content
        toc_depth: 2         ## level to be displayed in the table of content
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
                      dev = "ragg_png", fig.width = 9, fig.height = 6, dpi = 600, retina = 1)
Sys.setlocale("LC_TIME", "C")
```

* **Research question:**
* **Study area:**
* **Data:** 


# Setup

```{r packages}
# install the package librarian, it loads and installs (if necessary) the specified packages from CRAN, GitHub or Bioconductor

#devtools::install_github("DesiQuintans/librarian")
# librarian::shelf(update_all = FALSE,
#                  activity,
#                  #camtrapR,
#                  colorspace, 
#                  corrplot,
#                  #dplyr,
#                  EcoDynIZW / d6berlin,
#                  extrafont, 
#                  #evaluate, 
#                  gdata, 
#                  #ggplot2, 
#                  ggdist, 
#                  ggpubr, 
#                  here, 
#                  #janitor, 
#                  lubridate, 
#                  #maptools, 
#                  #ropenscilabs / ochRe,
#                  overlap,
#                  # "optimbase", maybe needed but has to be installed from the CRAN archive https://cran.r-project.org/web/packages/optimbase/index.html
#                  #plyr,
#                  #raster,
#                  #readxl, 
#                  #rgdal, 
#                  #rgeos, 
#                  #rjags, 
#                  #rlecuyer, 
#                  #scico,
#                  #sf, 
#                  #showtext, 
#                  skimr, 
#                  #snowfall, 
#                  #sp, 
#                  #stringr, 
#                  tidyverse, 
#                  #vroom
#                  )

# or use
library("here")
#library("activity")
library("lubridate")
library("overlap")
library("tidyverse")
```


# Data

```{r data}
#loading the environmental variables and using only the user IDs that are within the cov table
env_var <- readRDS(here::here("output",
                              "data-proc",
                              "all_seasons",
                              "env_var_binary_species_20230207.RDS"))
                              #"stacked_raster_values_and_garden_CT_all_seasons_no_nas_proc_20230124.RDS"))

#already formatted and filtered data 
# CT_act_date_proc <- readRDS(here::here("output", "data-proc", "all_seasons",
#                                        "CT_act_date_proc_20230124.RDS"))
CT_species_interest <- readRDS(here::here("output", 
                                          "data-proc", 
                                          "all_seasons",
                                          "CT_species_interest_with_env_20230207.RDS"))
```


# Calculate the mean number of pictures per hour per station

Add a column for the hour of the day
```{r}
CT_species_interest_hour_station <- CT_species_interest %>%
  mutate(hour_day = hour(Time)) %>%
  group_by(Species, project_phase, Station, Date, hour_day) %>%
   dplyr::summarise(pic_hour = n())
```

Split the dataset in separate lists per project phase
```{r}
CT_project_phase <- split(x = CT_species_interest_hour_station, f = CT_species_interest_hour_station$project_phase)
```

Fill the dataset with zeros for days and hours were no picture was taken per species
```{r}
# Phase 1
CT_phase1_species_station_date_hour <- CT_project_phase[[1]] %>%
  as.data.frame() %>%
  droplevels() %>%
  complete(Species, project_phase, Station, 
           Date = as.Date(as.Date("2018-10-07"):as.Date("2018-11-04"), origin="1970-01-01"), 
           hour_day = c(0:23), 
           fill = list(pic_hour = 0))

# # 29 days
# length(unique(CT_phase1$Date))
# # a 24 hours 
# length(unique(CT_phase1$hour_day))
# # a 5 species
# length(unique(CT_phase1$Species))
# # a 150 stations
# length(unique(CT_phase1$Station))
# # 29*24*5*150 = 522000 rows

# Phase 2
CT_phase2_species_station_date_hour <- CT_project_phase[[2]] %>%
  as.data.frame() %>%
  droplevels() %>%
  complete(Species, project_phase, Station, 
           Date = as.Date(as.Date("2019-04-01"):as.Date("2019-04-28"), origin="1970-01-01"), 
           hour_day = c(0:23), 
           fill = list(pic_hour = 0))

# Phase 3
CT_phase3_species_station_date_hour <- CT_project_phase[[3]] %>%
  as.data.frame() %>%
  droplevels() %>%
  complete(Species, project_phase, Station, 
           Date = as.Date(as.Date("2019-09-30"):as.Date("2019-10-27"), origin="1970-01-01"), 
           hour_day = c(0:23), 
           fill = list(pic_hour = 0))
# # 28 days
# length(unique(CT_phase3$Date))
# # a 24 hours 
# length(unique(CT_phase3$hour_day))
# # a 5 species
# length(unique(CT_phase3$Species))
# # a 133 stations
# length(unique(CT_phase3$Station))
# # 28*24*5*133 = 446880 rows


# Phase 4
CT_phase4_species_station_date_hour <- CT_project_phase[[4]] %>%
  as.data.frame() %>%
  droplevels() %>%
  complete(Species, project_phase, Station, 
           Date = as.Date(as.Date("2020-03-30"):as.Date("2020-04-26"), origin="1970-01-01"), 
           hour_day = c(0:23), 
           fill = list(pic_hour = 0))

# Phase 5
CT_phase5_species_station_date_hour <- CT_project_phase[[5]] %>%
  as.data.frame() %>%
  droplevels() %>%
  complete(Species, project_phase, Station, 
           Date = as.Date(as.Date("2020-09-28"):as.Date("2020-10-26"), origin="1970-01-01"), 
           hour_day = c(0:23), 
           fill = list(pic_hour = 0))
```

Combine all data sets
```{r}
CT_species_station_date_hour <- rbind(CT_phase1_species_station_date_hour, 
                                      CT_phase2_species_station_date_hour, 
                                      CT_phase3_species_station_date_hour, 
                                      CT_phase4_species_station_date_hour)
```

Calculate the mean per hour per station
```{r}
CT_species_station_mean_hour <- CT_species_station_date_hour %>%
  group_by(Species, project_phase, Station, hour_day) %>%
  summarize(mean_hour = mean(pic_hour), sd_hour = sd(pic_hour)) %>%
  left_join(y = env_var[, c(1, 3:25)], by = "Station")

# 5 species, 666 cameras, 24 hours = 79920
```


# Prepare data for activity plots and overlap calculation
```{r}
# Build a date column for the overlap calculation or plots (maybe not necessary)
CT_species_station_mean_hour$hour_day_overlap <- as.POSIXct(x = paste(CT_species_station_mean_hour$hour_day, 00, sep=":"), 
                                            format = "%H:%M", 
                                            tz = "GMT")
# Calculate the time in radians (for overlap calculation)
CT_species_station_mean_hour$time_rad <- (CT_species_station_mean_hour$hour_day/24)*2*pi
```


## Build a dataset only for squirrels
```{r}
CT_squirrels_station_mean_hour <- CT_species_station_mean_hour %>%
  filter(Species == "Squirrel")
```


# Overlap plots (TEST)
```{r}
# Overall
CT_squirrels_station_mean_hour %>%
  group_by(Season, hour_day) %>%
  dplyr::summarize(n_hour = mean(mean_hour), sd_hour = sd(mean_hour)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = hour_day, y = n_hour, colour = Season, fill = Season)) + 
  geom_ribbon(aes(ymin = case_when(n_hour - sd_hour < 0 ~ 0),  # limit the SD to 0, as there cannot be less than 0 images
                  ymax = n_hour + sd_hour, 
                  fill = Season, colour = NULL), alpha = 0.3) +
  geom_line(size =2) + 
  scale_x_continuous(
    limits = c(0,23), 
    breaks = seq(0, 21, by = 3),
    expand = c(.001, .001)) + 
  scale_y_continuous(
    limits = c(0, 0.07),
    breaks = seq(0, 0.07, by = 0.01),
    expand = c(.01, .001)) +
  labs(x = "Hour of the day", 
       y = "Mean number of pictures per station per hour of the day") + 
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        #legend.position = "none", 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill=NA, size=2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_colour_manual(values = pal_2) +
  scale_fill_manual(values = pal_2)

# Only phase 1
CT_squirrels_station_mean_hour %>%
  filter(project_phase == "1") %>%
  group_by(garden_type, hour_day) %>%
  dplyr::summarize(n_hour = mean(mean_hour), sd_hour = sd(mean_hour)) %>%
  ungroup() %>%
  ggplot(mapping = aes(x = hour_day, y = n_hour, colour = garden_type, fill = garden_type)) + 
  geom_ribbon(aes(ymin = case_when(n_hour - sd_hour < 0 ~ 0),  # limit the SD to 0, as there cannot be less than 0 images
                  ymax = n_hour + sd_hour, 
                  fill = garden_type, colour = NULL), alpha = 0.3) +
  geom_line(size =2) + 
  scale_x_continuous(
    limits = c(0,23), 
    breaks = seq(0, 21, by = 3),
    expand = c(.001, .001)) + 
  scale_y_continuous(
    limits = c(0, 0.08),
    breaks = seq(0, 0.08, by = 0.01),
    expand = c(.01, .001)) +
  labs(x = "Hour of the day", 
       y = "Mean number of pictures per station per hour of the day") + 
  theme_pubr() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(), 
        #legend.position = "none", 
        panel.background = element_rect(fill = "white"), 
        plot.background = element_rect(fill = "white"),
        panel.border = element_rect(colour = "black", fill=NA, size=2), 
        axis.ticks = element_line(colour = "black", linewidth = 2), 
        axis.ticks.length = unit(0.25, "cm"), 
        plot.margin = margin(6, 10, 4, 4)) + 
  labs_pubr(base_family = "Zilla Slab", base_size = 15) + 
  font(object = "xy.text", family = "Roboto", size = 11) + 
  scale_colour_manual(values = pal_2) +
  scale_fill_manual(values = pal_2)
```

# Calculate Dhat4
## camtrapR and overlap package
```{r}
## Plot with original data (with dates and times) - only to show that it worked
# one row per sighting
# squirrel vs cat 
camtrapR::activityOverlap(recordTable = CT_species_interest, 
                          speciesCol = "Species", 
                          speciesA = "Squirrel", 
                          speciesB = "Cat", 
                          recordDateTimeCol = "DateTimeOriginal", 
                          recordDateTimeFormat = "ymd HMS")

# spring vs autumn, all species 
camtrapR::activityOverlap(recordTable = CT_species_interest, 
                          speciesCol = "Season", 
                          speciesA = "spring", 
                          speciesB = "autumn", 
                          recordDateTimeCol = "DateTimeOriginal", 
                          recordDateTimeFormat = "ymd HMS")

## Plot with mean number of pictures per hour per station
camtrapR::activityOverlap(recordTable = CT_squirrels_station_mean_hour, 
                          speciesCol = "Season", 
                          speciesA = "spring", 
                          speciesB = "autumn", 
                          recordDateTimeCol = "hour_day_overlap", 
                          recordDateTimeFormat = "ymd HMS")
# Bandwidth estimation failed 
# because of the zeros??? 
# I read a bit, but ... I do not really understand it

# But normally you only feed in sightings here. I cannot even state here how many sightings there are. 
# The number is now only different because there are different numbers of stations per species. But otherwise there are 24 lines per station. 
```

Use only the overlap estimator from the overlap package
```{r}
CT_squirrels_autumn <- CT_squirrels_station_mean_hour[CT_squirrels_station_mean_hour$Season == "autumn", ]$time_rad
CT_squirrels_spring <- CT_squirrels_station_mean_hour[CT_squirrels_station_mean_hour$Season == "spring", ]$time_rad
overlapEst(A = CT_squirrels_autumn, B = CT_squirrels_spring, kmax = 3, adjust = c(0.8, 1, 4), type = "all")
overlapEst(A = CT_squirrels_autumn, B = CT_squirrels_spring, kmax = 3, adjust = 0.8, type = "all")
overlapEst(A = CT_squirrels_autumn, B = CT_squirrels_spring, kmax = 3, adjust = 0.08, type = "all")
# Only NAs the help says: "Will be NA if optimal bandwidth estimation failed."
# ?overlapEst

# But ... 
overlapEst(A = CT_squirrels_autumn, B = CT_squirrels_spring, kmax = 50, adjust = c(0.8, 1, 4), type = "all")
overlapEst(A = CT_squirrels_autumn, B = CT_squirrels_spring, kmax = 50, adjust = 0.8, type = "all")
overlapEst(A = subset(CT_squirrels_station_mean_hour, Season == "autumn")$time_rad, # also works, so I do not have to subset everything
           B = subset(CT_squirrels_station_mean_hour, Season == "spring")$time_rad, 
           kmax = 50, 
           adjust = c(0.8, 1, 4), 
           type = "all")
# Now it works. But is the result correct?
# In the ggplot (from line 232) it does not look like an overlap of 0.966. Or am I wrong there?
# density(CT_squirrels_autumn)
```

Trying overlap again
```{r}
recordTable = CT_species_interest, 
                          speciesCol = "Species", 
                          speciesA = "Squirrel", 
                          speciesB = "Cat", 
                          recordDateTimeCol = "DateTimeOriginal", 
                          recordDateTimeFormat = "ymd HMS"


Squirrels_spring <- CT_species_interest %>%
  filter(Species == "Squirrel") %>%
  filter(Season == "spring") %>%
  mutate(hour_day = hour(Time)) %>%
  mutate(rad_time = (hour_day/24) * 2 * pi) %>%
  select(Time, rad_time)

Squirrels_autumn <- CT_species_interest %>%
  filter(Species == "Squirrel") %>%
  filter(Season == "autumn") %>%
  mutate(hour_day = hour(Time)) %>%
  mutate(rad_time = (hour_day/24) * 2 * pi) %>%
  select(Time, rad_time)

densityPlot(Squirrels$rad_time, rug=TRUE)

Cats_spring <- CT_species_interest %>%
  filter(Species == "Cat") %>%
  filter(Season == "spring") %>%
  mutate(hour_day = hour(Time)) %>%
  mutate(rad_time = (hour_day/24) * 2 * pi) %>%
  select(Time, rad_time)

Cats_autumn <- CT_species_interest %>%
  filter(Species == "Cat") %>%
  filter(Season == "autumn") %>%
  mutate(hour_day = hour(Time)) %>%
  mutate(rad_time = (hour_day/24) * 2 * pi) %>%
  select(Time, rad_time)

densityPlot(Cats_autumn$rad_time, rug=TRUE)

sq_ca_d4 <- overlapEst(A = Squirrels$rad_time, B = Cats$rad_time, kmax = 50, type = "Dhat4")

spring_EST <- overlapEst(A = Squirrels_spring$rad_time, B= Cats_spring$rad_time, kmax = 50, type = "Dhat4")
autumn_EST <- overlapEst(A = Squirrels_autumn$rad_time, B= Cats_autumn$rad_time, kmax = 50, type = "Dhat4")
spring_EST
autumn_EST
# We are doing bootstrap to get CI, nb has to be at least 1000, better 10000
tigmac2 <- overlap::bootstrap(A = Squirrels$rad_time, B = Cats$rad_time, kmax = 50, nb = 100, type="Dhat4") # takes a few seconds
tigmac2

mean(tigmac2) 

bootCI(sq_ca_d4, tigmac2)
#######
spring <- overlap::bootstrap(A = Squirrels_spring$rad_time, B= Cats_spring$rad_time, kmax = 50, nb = 100, type="Dhat4") # takes a few seconds

mean(spring) 

bootCI(spring_EST, spring)

autumn <- overlap::bootstrap(A = Squirrels_autumn$rad_time, B= Cats_autumn$rad_time, kmax = 50, nb = 100, type="Dhat4") # takes a few seconds


mean(autumn) 

bootCI(autumn_EST, autumn)


```
# TEST
```{r}
recordTable2 <- CT_species_interest[,c(1:8)]
#recordTable$Time2 <-   format(recordTable$Time, format = "%H:%M:%S", usetz = FALSE)
recordTable2$Time.rad <- (as.numeric(as.POSIXct(strptime(recordTable2$Time, 
                                                        format = "%H:%M:%S", 
                                                        tz = "UTC"))) -
                           as.numeric(as.POSIXct(strptime("0", 
                                                          format = "%S", 
                                                          tz = "UTC")))) / 3600 * (pi/12)
Squirrels_spring_test <- recordTable2 %>%
  filter(Species == "Squirrel") %>%
  filter(Season == "spring") %>%
  select(Time, Time.rad)

densityPlot(Squirrels_spring$rad_time, rug = TRUE)
densityPlot(Squirrels_spring_test$Time.rad, rug = TRUE)
activityDensity(recordTable = CT_species_interest[CT_species_interest$Species == "Squirrel", ], species = "spring", speciesCol = "Season")

# sq_season <- activityOverlap(recordTable = CT_species_interest[CT_species_interest$Species == "Squirrel", ], 
#                              speciesA = "autumn", 
#                              speciesB = "spring", 
#                              speciesCol = "Season", 
#                              overlapEstimator = "Dhat4")
```


## activity package
### Squirrels only
```{r}
# This needs some time (~15 min)
mod_squirrel_spring <- fitact(dat =subset(CT_squirrels_station_mean_hour, Season == "spring")$time_rad, 
                              wt = subset(CT_squirrels_station_mean_hour, Season == "spring")$mean_hour, 
                              sample = "data")
mod_squirrel_autumn <- fitact(dat =subset(CT_squirrels_station_mean_hour, Season == "autumn")$time_rad, 
                              wt = subset(CT_squirrels_station_mean_hour, Season == "autumn")$mean_hour, 
                              sample = "data")
```


```{r}
# calculate Dhat4
ovl4(mod_squirrel_spring, mod_squirrel_autumn) # 0.9999995 That cannot be correct or??? Higher as Dhat4 calculated with overlap package
# Overlap calculation with camtrapR
overlapEst(A = subset(CT_squirrels_station_mean_hour, Season == "autumn")$time_rad, # also works, so I do not have to subset everything
           B = subset(CT_squirrels_station_mean_hour, Season == "spring")$time_rad, 
           kmax = 50, 
           adjust = c(0.8, 1, 4), 
           type = "all") # 0.966
# Compare activity level estimates
compareAct(list(mod_squirrel_spring,mod_squirrel_autumn))
# Compare circular distributions.
compareCkern(mod_squirrel_spring,mod_squirrel_autumn,reps=10)
# Plots
plot(mod_squirrel_spring)
plot(mod_squirrel_autumn)
```

### Species of interest with original dates
Here I am sure that the overlap package works
```{r}
# calculate time in radians for CT_species interest
# activity package has a function for that
CT_species_interest$time_rad <- gettime(x = CT_species_interest$DateTimeOriginal, format = "%Y-%m-%d %H:%M:%S", scale = "radian")

# Needs more time (20-50 min)
# Without weights because it is the dataset with sightings only (corrected data: without zeros, original dates)
mod_squirrel_all <- fitact(dat = subset(CT_species_interest, Species == "Squirrel")$time_rad, 
                           #wt = subset(CT_species_interest, Species == "Squirrel")$mean_hour, 
                           sample = "data")
mod_cat_all <- fitact(dat = subset(CT_species_interest, Species == "Cat")$time_rad, 
                      #wt = subset(CT_species_interest, Species == "Cat")$mean_hour, 
                      sample = "data")
```


```{r}
# Calculate Dhat4
ovl4(mod_squirrel_all, mod_cat_all) 
overlap::overlapEst(A = subset(CT_species_interest, Species == "Squirrel")$time_rad, 
                    B = subset(CT_species_interest, Species == "Cat")$time_rad, 
                    kmax = 3, 
                    adjust = c(0.8,1,4), 
                    type = "all")
overlap::overlapEst(A = subset(CT_species_interest, Species == "Squirrel")$time_rad, 
                    B = subset(CT_species_interest, Species == "Cat")$time_rad, 
                    kmax = 50, 
                    adjust = c(0.8,1,4), 
                    type = "all")
```


# Further analysis
Per project phase and not overall, right?

And is the calculation correct? You wrote in one of the emails that I should do this calculation per cam. Then I have to change the calculation, maybe I can do it with a for loop?


***

<details><summary>Session Info</summary>

```{r sessionInfo}
## DO NOT REMOVE!
## We store the settings of your computer and the current versions of the
## packages used to allow for reproducibility
Sys.time()
#git2r::repository() ## uncomment if you are using GitHub
sessionInfo()
```

</details>
